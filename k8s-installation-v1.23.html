<html>
<head>
  <title>安装 Kubernetes 集群 1.23</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/309091 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="1519"/>
<h1>安装 Kubernetes 集群 1.23</h1>

<div>
<span><div><a href="https://www.downloadkubernetes.com/">https://www.downloadkubernetes.com/</a></div><div>STABLE VERSIONS：v1.23.7</div><div><br/></div><div>0. 前提：</div><div>安装 docker；关闭 swap；如果是 centos，关闭防火墙及关闭 selinux；</div><div>可能要确认 cgroup-driver：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>root@vm-ubuntu-1:/run# docker info | grep -i &quot;Cgroup Driver&quot;</div><div>Cgroup Driver: <b><font color="#41AD1C">systemd</font></b></div></div><div><br/></div><div>1. 先添加阿里源的apt公钥</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>curl https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | sudo apt-key add</div></div><div>不然后面 apt-get update 会报错：</div><div><span style="color: rgb(168, 168, 168);">Err:1 http://mirrors.ustc.edu.cn/kubernetes/apt kubernetes-xenial InRelease                                                                                 </span></div><div><span style="color: rgb(168, 168, 168);">  The following signatures couldn't be verified because the public key is not available: NO_PUBKEY FEEA9169307EA071 NO_PUBKEY 8B57C5C2836F4BEB</span></div><div><br/></div><div>2. 添加阿里的源</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>echo &quot;deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main&quot; | sudo tee /etc/apt/sources.list.d/kubernetes.list</div></div><div><br/></div><div>3. Update apt package index, install kubelet, kubeadm and kubectl, and pin their version:</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>sudo apt-get update</div><div>sudo apt-get install -y kubelet=1.23.7-00 kubeadm=1.23.7-00 kubectl=1.23.7-00</div><div>sudo apt-mark hold kubelet=1.23.7-00 kubeadm=1.23.7-00 kubectl=1.23.7-00</div></div><div><br/></div><div><span style="color: rgb(168, 168, 168);">以下步骤除 8 以外都在master上执行</span></div><div>4. kubeadm初始化<span style="font-weight: bold;">（注意问题2）</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>kubeadm init --kubernetes-version v1.23.7 --pod-network-cidr=10.244.0.0/16</div></div><div><br/></div><div>5. admin.conf</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>要使非 root 用户可以运行 kubectl，请运行以下命令， 它们也是 kubeadm init 输出的一部分：</div><div>mkdir -p $HOME/.kube</div><div>sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</div><div>sudo chown $(id -u):$(id -g) $HOME/.kube/config</div><div><br/></div><div>或者，如果你是 root 用户，则可以运行：</div><div>export KUBECONFIG=/etc/kubernetes/admin.conf</div></div><div><br/></div><div>6. 安装 Flannel 网络插件 <span style="font-size: medium; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(0, 0, 0); font-family: 微软雅黑; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">（问题3）</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>curl --insecure -sfL https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml | kubectl apply -f -</div></div><div><br/></div><div>7. 移除 Master 节点上的污点（可选）</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>kubectl taint nodes --all node-role.kubernetes.io/master-</div></div><div><br/></div><div><font style="color: rgb(54, 101, 238);">8. node 需要 pull 镜像到本地，因为GWF</font></div><div><br/></div><div><span style="color: rgb(54, 101, 238);">9. node 加入集群</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>kubeadm join 192.168.2.101:6443 --token bpzvmt.4hm9nwbg8yxvu1dn \</div><div>    --discovery-token-ca-cert-hash sha256:cb54494ea5645e8d90bf7ada0c009322a716a51e651d2fb86a418f09d9e74da1</div></div><div><br/></div><div>10. 验证</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>root@vm-ubuntu-1:/var/lib/etcd/member# kubectl get nodes</div><div>NAME          STATUS   ROLES                  AGE     VERSION</div><div>vm-ubuntu-1   Ready    control-plane,master   3h40m   v1.23.7</div><div>vm-ubuntu-2   Ready    &lt;none&gt;                 3h20m   v1.23.7</div><div>vm-ubuntu-3   Ready    &lt;none&gt;                 3h19m   v1.23.7</div></div><div><br/></div><div><br/></div><div><span style="font-size: 12pt; font-weight: bold;">问题记录：</span></div><div>1.</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>root@vm-ubuntu-3:~# sudo apt-get install -y kubelet=1.23.7-00 kubeadm=1.23.7-00</div><div>E: Could not get lock /var/lib/dpkg/lock-frontend. It is held by process 4290 (unattended-upgr)</div><div>N: Be aware that removing the lock file is not a solution and may break your system.</div><div>E: Unable to acquire the dpkg frontend lock (/var/lib/dpkg/lock-frontend), is another process using it?</div><div>root@vm-ubuntu-3:~#</div><div>root@vm-ubuntu-3:~# ps -ef|grep 4290</div><div>root        4290    4258  6 21:24 ?        00:00:14 /usr/bin/python3 /usr/bin/unattended-upgrade</div><div>root       26487    4290  6 21:28 ?        00:00:00 /usr/bin/python3 /usr/bin/unattended-upgrade</div><div>root       26590    3766  0 21:28 pts/1    00:00:00 grep --color=auto 4290</div></div><div>说是因为ubuntu在更新东西，所以会锁住dpkg file，等待更新完成即可，不要按有些文章说的那样删 lock 文件</div><div><a href="https://itsfoss.com/could-not-get-lock-error/">https://itsfoss.com/could-not-get-lock-error/</a></div><div><br/></div><div>2.</div><div><span style="color: rgb(255, 0, 0);">kubeadm init 拉取镜像很慢</span></div><div>查看 kubernets 集群需要的镜像包：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>root@vm-ubuntu-1:~# kubeadm config images list --kubernetes-version v1.23.7</div><div>k8s.gcr.io/kube-apiserver:v1.23.7</div><div>k8s.gcr.io/kube-controller-manager:v1.23.7</div><div>k8s.gcr.io/kube-scheduler:v1.23.7</div><div>k8s.gcr.io/kube-proxy:v1.23.7</div><div>k8s.gcr.io/pause:3.6</div><div>k8s.gcr.io/etcd:3.5.1-0</div><div>k8s.gcr.io/coredns/coredns:v1.8.6</div></div><div>从阿里云仓库拉取镜像包：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>docker pull registry.aliyuncs.com/google_containers/kube-apiserver:v1.23.7</div><div>docker pull registry.aliyuncs.com/google_containers/kube-controller-manager:v1.23.7</div><div>docker pull registry.aliyuncs.com/google_containers/kube-scheduler:v1.23.7</div><div>docker pull registry.aliyuncs.com/google_containers/kube-proxy:v1.23.7</div><div>docker pull registry.aliyuncs.com/google_containers/pause:3.6</div><div>docker pull registry.aliyuncs.com/google_containers/etcd:3.5.1-0</div><div>docker pull registry.aliyuncs.com/google_containers/coredns:1.8.6</div><div><br/></div><div><font color="#A8A8A8">建好别名以后可以删掉</font></div><div><font color="#A8A8A8">docker rmi registry.aliyuncs.com/google_containers/kube-apiserver:v1.23.7</font></div><div><font color="#A8A8A8">docker rmi registry.aliyuncs.com/google_containers/kube-controller-manager:v1.23.7</font></div><div><font color="#A8A8A8">docker rmi registry.aliyuncs.com/google_containers/kube-scheduler:v1.23.7</font></div><div><font color="#A8A8A8">docker rmi registry.aliyuncs.com/google_containers/kube-proxy:v1.23.7</font></div><div><font color="#A8A8A8">docker rmi registry.aliyuncs.com/google_containers/pause:3.6</font></div><div><font color="#A8A8A8">docker rmi registry.aliyuncs.com/google_containers/etcd:3.5.1-0</font></div><div><font color="#A8A8A8">docker rmi registry.aliyuncs.com/google_containers/coredns:1.8.6</font></div></div><div>给镜像包设置别名：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>docker tag registry.aliyuncs.com/google_containers/kube-apiserver:v1.23.7 k8s.gcr.io/kube-apiserver:v1.23.7</div><div>docker tag registry.aliyuncs.com/google_containers/kube-controller-manager:v1.23.7 k8s.gcr.io/kube-controller-manager:v1.23.7</div><div>docker tag registry.aliyuncs.com/google_containers/kube-scheduler:v1.23.7 k8s.gcr.io/kube-scheduler:v1.23.7</div><div>docker tag registry.aliyuncs.com/google_containers/kube-proxy:v1.23.7 k8s.gcr.io/kube-proxy:v1.23.7</div><div>docker tag registry.aliyuncs.com/google_containers/pause:3.6 k8s.gcr.io/pause:3.6</div><div>docker tag registry.aliyuncs.com/google_containers/etcd:3.5.1-0 k8s.gcr.io/etcd:3.5.1-0</div><div>docker tag registry.aliyuncs.com/google_containers/coredns:1.8.6 k8s.gcr.io/coredns/coredns:v1.8.6</div></div><div><br/></div><div>3.</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>root@vm-ubuntu-1:~# curl --insecure -sfL https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml | kubectl apply -f -</div><div>error: no objects passed to apply</div></div><div>DNS 污染，先翻墙下下来</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>root@vm-ubuntu-1:~# cat kube-flannel.yml | kubectl apply -f -</div><div>Warning: policy/v1beta1 PodSecurityPolicy is deprecated in v1.21+, unavailable in v1.25+</div><div>podsecuritypolicy.policy/psp.flannel.unprivileged created</div><div>clusterrole.rbac.authorization.k8s.io/flannel created</div><div>clusterrolebinding.rbac.authorization.k8s.io/flannel created</div><div>serviceaccount/flannel created</div><div>configmap/kube-flannel-cfg created</div><div>daemonset.apps/kube-flannel-ds created</div></div><div><br/></div><div><br/></div><div>其它命令：</div><div>journalctl -f -u kubelet</div></span>
</div></body></html> 